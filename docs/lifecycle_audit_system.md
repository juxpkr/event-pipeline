# GDELT Event Lifecycle ê°ì‚¬ ì‹œìŠ¤í…œ

## ğŸ“‹ ê°œìš”

ê¸°ì¡´ ë³µì¡í•œ 4ì  ê°ì‚¬ ì‹œìŠ¤í…œì„ **ì‹¤ì œ ì´ë²¤íŠ¸ ìƒëª…ì£¼ê¸° ì¶”ì **ìœ¼ë¡œ í˜ì‹ í•œ ë°ì´í„° í’ˆì§ˆ ë³´ì¥ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### í•µì‹¬ ì•„ì´ë””ì–´
- **ê° event_idì˜ ì‹¤ì œ ì—¬ì • ì¶”ì **: Bronze â†’ Silver â†’ Gold â†’ Postgres
- **Delta Lake ê¸°ë°˜ lifecycle í…Œì´ë¸”**: ì‹¤ì‹œê°„ ìƒíƒœ ê´€ë¦¬
- **ì •í™•í•œ ì¡°ì¸ ì„±ê³µë¥  ì¸¡ì •**: 15ì‹œê°„ ìˆœíšŒ ì¡°ì¸ ë¡œì§ì˜ ì‹¤ì œ ì„±ê³¼ ì¸¡ì •
- **ìë™ ë°ì´í„° ìœ ì‹¤ íƒì§€**: 24ì‹œê°„ ì´ìƒ ëŒ€ê¸° ì´ë²¤íŠ¸ ìë™ ë§Œë£Œ

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Bronze    â”‚    â”‚   Silver    â”‚    â”‚    Gold     â”‚    â”‚ PostgreSQL  â”‚
â”‚   Layer     â”‚    â”‚   Layer     â”‚    â”‚   Layer     â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                  â”‚                  â”‚
      â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Event Lifecycle Delta Table                           â”‚
â”‚  global_event_id | bronze_arrival | detailed_joined | status | batch   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  20241201001     | 2024-12-01 15:00| 2024-12-01 18:30| JOINED | b123   â”‚
â”‚  20241201002     | 2024-12-01 15:00| NULL            | WAITING| b123   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ LifecycleAuditorâ”‚
                            â”‚   ê°ì‚¬ ì‹œìŠ¤í…œ    â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   Prometheus    â”‚
                            â”‚   & Grafana     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ë“¤

### 1. **í•µì‹¬ ì»´í¬ë„ŒíŠ¸ë“¤**

#### ğŸ“„ `src/audit/lifecycle_tracker.py`
**ì—­í• **: Event Lifecycle ë°ì´í„° ê´€ë¦¬ (CRUD)
- Delta Lake í…Œì´ë¸” ì´ˆê¸°í™”
- Bronze ë„ì°© ì´ë²¤íŠ¸ ê¸°ë¡ (WAITING ìƒíƒœ)
- ì¡°ì¸ ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ (JOINED ìƒíƒœ)
- ì˜¤ë˜ëœ ì´ë²¤íŠ¸ ë§Œë£Œ ì²˜ë¦¬ (EXPIRED ìƒíƒœ)

```python
# ì£¼ìš” ë©”ì„œë“œ
track_bronze_arrival(events_df, batch_id)      # Bronze ë„ì°© ì‹œ INSERT
mark_events_joined(event_ids, batch_id)        # ì¡°ì¸ ì„±ê³µ ì‹œ UPDATE
expire_old_waiting_events(hours_threshold=24)  # ìë™ ë§Œë£Œ ì²˜ë¦¬
```

#### ğŸ“„ `src/validation/lifecycle_auditor.py`
**ì—­í• **: 4ê°€ì§€ í•µì‹¬ ê°ì‚¬ ë¡œì§ ì‹¤í–‰
- **ìˆ˜ì§‘ ì •í™•ì„±**: GDELT ì˜ˆìƒ vs ì‹¤ì œ ì¶”ì  ì´ë²¤íŠ¸
- **ì¡°ì¸ ì„±ê³µë¥ **: 12-24ì‹œê°„ ì„±ìˆ™ ì´ë²¤íŠ¸ì˜ ì¡°ì¸ìœ¨
- **ë°ì´í„° ìœ ì‹¤ íƒì§€**: 24ì‹œê°„+ ëŒ€ê¸° ì´ë²¤íŠ¸ ë°œê²¬
- **Gold-Postgres ë™ê¸°í™”**: 100% ì¼ì¹˜ ê²€ì¦

```python
# ì£¼ìš” ê°ì‚¬ ë©”ì„œë“œ
audit_collection_accuracy()     # ìˆ˜ì§‘ë¥  ê²€ì¦
audit_join_yield()              # ì¡°ì¸ ì„±ê³µë¥  ì¸¡ì •
audit_data_loss_detection()     # ìœ ì‹¤ ì˜ì‹¬ ì´ë²¤íŠ¸ íƒì§€
audit_gold_postgres_sync()      # ë™ê¸°í™” ì •í™•ì„± ê²€ì¦
```

#### ğŸ“„ `src/validation/lifecycle_metrics_exporter.py`
**ì—­í• **: Prometheus ë©”íŠ¸ë¦­ ì „ì†¡
- ê°ì‚¬ ê²°ê³¼ë¥¼ 12ê°œ í•µì‹¬ ë©”íŠ¸ë¦­ìœ¼ë¡œ ë³€í™˜
- Pushgatewayë¥¼ í†µí•œ Grafana ì—°ë™
- ì‹¤ì‹œê°„ ì•ŒëŒ íŠ¸ë¦¬ê±°

### 2. **ê¸°ì¡´ íŒŒì´í”„ë¼ì¸ ìˆ˜ì •**

#### ğŸ”§ `src/processing/gdelt_silver_processor.py` (ìˆ˜ì •ë¨)
**ì¶”ê°€ëœ ê¸°ëŠ¥**:
- Bronze â†’ Silver ì²˜ë¦¬ í›„ lifecycle ê¸°ë¡
- 3-way join ì„±ê³µ í›„ JOINED ìƒíƒœ ì—…ë°ì´íŠ¸

```python
# ì¶”ê°€ëœ ì½”ë“œ
lifecycle_tracker = EventLifecycleTracker(spark)
tracked_count = lifecycle_tracker.track_bronze_arrival(events_silver_df, batch_id)
updated_count = lifecycle_tracker.mark_events_joined(joined_event_ids, batch_id)
```

### 3. **ìš´ì˜ ë° ë°°í¬**

#### ğŸ“„ `dags/gdelt_lifecycle_audit_dag.py`
**ì—­í• **: Airflowë¥¼ í†µí•œ ì •ê¸° ê°ì‚¬ ì‹¤í–‰
- **4ì‹œê°„ë§ˆë‹¤** lifecycle audit ì‹¤í–‰
- **48ì‹œê°„ ì´ìƒ** ëŒ€ê¸° ì´ë²¤íŠ¸ ìë™ ë§Œë£Œ
- Docker Swarm í™˜ê²½ì—ì„œ ì‹¤í–‰

#### ğŸ“„ `spark-base/requirements-spark.txt` (ìˆ˜ì •ë¨)
**ì¶”ê°€ë¨**: `prometheus_client==0.20.0`

## ğŸ”„ ë°ì´í„° íë¦„ (Data Flow)

### 1. **ì´ë²¤íŠ¸ ì¶”ì  ì‹œì‘**
```
GDELT Source â†’ Bronze Layer â†’ Silver Processor
                                      â†“
                         lifecycle_tracker.track_bronze_arrival()
                                      â†“
              audit.event_lifecycle í…Œì´ë¸”ì— INSERT
              Status: WAITING, bronze_arrival_time: NOW()
```

### 2. **3-Way ì¡°ì¸ ì„±ê³µ ì‹œ**
```
Silver Processor (3-way join ì™„ë£Œ) â†’ joined_event_ids ì¶”ì¶œ
                                             â†“
                          lifecycle_tracker.mark_events_joined()
                                             â†“
                          audit.event_lifecycle í…Œì´ë¸” UPDATE
                          Status: WAITING â†’ JOINED, detailed_joined_time: NOW()
```

### 3. **ì •ê¸° ê°ì‚¬ ì‹¤í–‰** (4ì‹œê°„ë§ˆë‹¤)
```
LifecycleAuditor.run_full_audit()
        â†“
â”Œâ”€ ìˆ˜ì§‘ ì •í™•ì„± (ìµœê·¼ 1ì‹œê°„)
â”œâ”€ ì¡°ì¸ ì„±ê³µë¥  (12-24ì‹œê°„ ì „ ì´ë²¤íŠ¸)
â”œâ”€ ë°ì´í„° ìœ ì‹¤ íƒì§€ (24ì‹œê°„+ ëŒ€ê¸°)
â””â”€ Gold-Postgres ë™ê¸°í™” ê²€ì¦
        â†“
MetricsExporter â†’ Prometheus â†’ Grafana
```

## ğŸ“Š í•µì‹¬ ë©”íŠ¸ë¦­ & ì•ŒëŒ

### Grafana ëŒ€ì‹œë³´ë“œ ë©”íŠ¸ë¦­
- **`gdelt_collection_rate`**: ìˆ˜ì§‘ë¥  (ëª©í‘œ: 70%+)
- **`gdelt_join_yield`**: ì¡°ì¸ ì„±ê³µë¥  (ëª©í‘œ: 80%+)
- **`gdelt_suspicious_events`**: ì˜ì‹¬ ì´ë²¤íŠ¸ ìˆ˜ (ëª©í‘œ: 0ê°œ)
- **`gdelt_pipeline_health`**: ì „ì²´ íŒŒì´í”„ë¼ì¸ ìƒíƒœ (1=HEALTHY, 0=UNHEALTHY)

### ì•ŒëŒ ê·œì¹™
```promql
# Critical
gdelt_pipeline_health == 0           # ì „ì²´ ì‹¤íŒ¨
gdelt_collection_rate < 50           # ì‹¬ê°í•œ ìˆ˜ì§‘ ì‹¤íŒ¨
gdelt_gold_postgres_sync < 100       # ë™ê¸°í™” ì‹¤íŒ¨

# Warning
gdelt_join_yield < 80                # ì¡°ì¸ ì„±ê³µë¥  ì €í•˜
gdelt_suspicious_events > 0          # ì˜ì‹¬ ì´ë²¤íŠ¸ ë°œìƒ
```

## ğŸš€ ë°°í¬ ë° ì‹¤í–‰

### Docker Swarm í™˜ê²½ ë°°í¬
```bash
# 1. ì´ë¯¸ì§€ ì¬ë¹Œë“œ (prometheus_client ì¶”ê°€)
docker service update --force event-pipeline_spark-master
docker service update --force event-pipeline_spark-worker

# 2. DAG ìë™ ë“±ë¡ (íŒŒì¼ë§Œ ì¶”ê°€í•˜ë©´ ë¨)
# gdelt_lifecycle_audit_dag.py â†’ Airflow UIì—ì„œ í™œì„±í™”

# 3. ìˆ˜ë™ í…ŒìŠ¤íŠ¸ (í•„ìš”ì‹œ)
docker exec -it <spark-container> python /opt/airflow/src/validation/lifecycle_auditor.py
```

## ğŸ¯ ê¸°ëŒ€ íš¨ê³¼

### AS-IS (ê¸°ì¡´)
- "ë­”ê°€ ì´ìƒí•œë° ë­ê°€ ë¬¸ì œì¸ì§€ ëª¨ë¦„" ğŸ˜•
- ë³µì¡í•œ 600ì¤„ ì½”ë“œë¡œ ë¶€ì •í™•í•œ ê°ì‚¬
- 15ì‹œê°„ ìˆœíšŒ ì¡°ì¸ ë¡œì§ì„ ì •í™•íˆ ê²€ì¦ ë¶ˆê°€

### TO-BE (ê°œì„  í›„)
- "Join Yield 75% â†’ ë°°ì¹˜ XYZ ë¬¸ì œ â†’ ì¬ì²˜ë¦¬ í•„ìš”" ğŸ¯
- ì‹¤ì œ ì´ë²¤íŠ¸ ì—¬ì • ì¶”ì ìœ¼ë¡œ ì •í™•í•œ ê°ì‚¬
- Grafana ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ + ìë™ ì•ŒëŒ
- 24ì‹œê°„+ ìœ ì‹¤ ì´ë²¤íŠ¸ ìë™ íƒì§€ & ë§Œë£Œ

**ì§„ì§œ ë°ì´í„° ì—”ì§€ë‹ˆì–´ë§ë‹¤ìš´ ê°ì‚¬ ì‹œìŠ¤í…œ ì™„ì„±!** ğŸ”¥